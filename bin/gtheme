#!/usr/bin/env bash
set -euo pipefail

THEMES_DIR="/Applications/Ghostty.app/Contents/Resources/ghostty/themes"
THEME_FILE="$HOME/.config/ghostty/current-theme"
LAST_THEME_FILE="$HOME/.config/ghostty/.last-theme"
SELF="$(cd "$(dirname "$0")" && pwd)/$(basename "$0")"

# Send an OSC sequence to the terminal, wrapping in DCS passthrough for tmux
osc() {
  if [[ -n "${TMUX:-}" ]]; then
    printf '\ePtmux;\e\e]%s\a\e\\' "$1" > /dev/tty
  else
    printf '\e]%s\a' "$1" > /dev/tty
  fi
}

# Apply a theme by parsing its file and sending OSC color sequences
apply_theme() {
  local file="$THEMES_DIR/$1"
  [[ -f "$file" ]] || return 0

  while IFS= read -r line; do
    case "$line" in
      palette\ =\ *)
        local rest="${line#palette = }"
        local num="${rest%%=*}"
        local color="${rest#*=}"
        osc "4;$num;$color"
        ;;
      background\ =\ *)
        osc "11;${line#background = }"
        ;;
      foreground\ =\ *)
        osc "10;${line#foreground = }"
        ;;
      cursor-color\ =\ *)
        osc "12;${line#cursor-color = }"
        ;;
    esac
  done < "$file"
}

# --- Apply mode: called by fzf focus binding ---
if [[ "${1:-}" == "--apply" ]]; then
    shift
    apply_theme "$*"
    exit 0
fi

# --- Interactive mode ---
[[ -d "$THEMES_DIR" ]] || { echo "error: Ghostty themes dir not found" >&2; exit 1; }
mkdir -p "$(dirname "$THEME_FILE")"

original_theme=$(cat "$LAST_THEME_FILE" 2>/dev/null || true)
last="$original_theme"

theme_list=$(
  if [[ -n "$last" ]] && [[ -f "$THEMES_DIR/$last" ]]; then
    echo "$last"
    ls "$THEMES_DIR" | grep -vxF "$last"
  else
    ls "$THEMES_DIR"
  fi
)
count=$(printf '%s\n' "$theme_list" | wc -l | tr -d ' ')

selected=$(printf '%s\n' "$theme_list" | \
  FZF_DEFAULT_OPTS="" \
  fzf \
    --no-sort \
    --layout=reverse \
    --height=80% \
    --prompt="  theme > " \
    --header="$count themes" \
    --bind "focus:execute-silent(\"$SELF\" --apply {})" \
) || true

if [[ -n "$selected" ]]; then
  apply_theme "$selected"
  cat "$THEMES_DIR/$selected" > "$THEME_FILE"
  echo "$selected" > "$LAST_THEME_FILE"
  echo "Applied: $selected"
else
  if [[ -n "$original_theme" ]] && [[ -f "$THEMES_DIR/$original_theme" ]]; then
    apply_theme "$original_theme"
  fi
  echo "Reverted."
fi
